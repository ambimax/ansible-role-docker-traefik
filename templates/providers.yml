http:
  routers:
{% if traefik_https %}
    api:
      rule: Host(`{{ traefik_hostname }}`)
      service: api@internal
      entryPoints: [http]
      middlewares:
        - https-redirect

    api-secure:
      rule: Host(`{{ traefik_hostname }}`)
      tls:
        certResolver: le
      service: api@internal
      entryPoints: [https]
      {% if traefik_users_basic_auth is defined and (traefik_users_basic_auth | length > 0) %}
      middlewares:
        - auth
      {% endif %}

  middlewares:
    https-redirect:
      redirectScheme:
        scheme: https

    {% if traefik_users_basic_auth is defined and (traefik_users_basic_auth | length > 0) %}
    auth:
      basicAuth:
        users:
        {% for user in traefik_users_basic_auth %}
          - "{{ user }}"
        {% endfor %}
    {% endif %}

{% else %}
  routers:
    api:
      rule: Host(`{{ traefik_hostname }}`)
      service: api@internal
      entryPoints: [http]
      {% if traefik_users_basic_auth is defined and (traefik_users_basic_auth | length > 0) %}
      middlewares:
        - auth
      {% endif %}

  middlewares:
  {% if traefik_users_basic_auth is defined and (traefik_users_basic_auth | length > 0) %}
    auth:
      basicAuth:
        users:
        {% for user in traefik_users_basic_auth %}
          - "{{ user }}"
        {% endfor %}
  {% endif %}
{% endif %}
